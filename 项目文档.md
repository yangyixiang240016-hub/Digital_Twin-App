# 污水处理厂智能数字孪生平台 - 项目文档

## 一、项目概述

### 1.1 项目简介

本项目是一个**污水处理厂智能数字孪生平台**，为北湖污水处理厂提供全方位的数字化管理和智能优化服务。系统集成了3D可视化、实时监控、数据清洗、模拟仿真、优化控制等核心功能，实现了污水处理过程的数字化、智能化和可视化。

### 1.2 项目背景

北湖污水处理厂近期主要服务于武昌沙湖、二郎庙、落步咀、白玉山污水系统，服务面积130.35km²，近期服务人口约为177.5万人。污水处理厂近期建设规模为80×10000m³/d，位于腾飞大道与八吉府路交汇处东北侧，用地面积为1400亩。

### 1.3 核心价值

- **数字孪生**：通过3D建模实现污水处理厂的虚拟映射
- **智能优化**：基于算法模型进行参数优化和运行策略制定
- **实时监控**：实时展示各工艺段的水质、流量等关键指标
- **预测分析**：基于历史数据进行趋势预测和异常预警
- **数据治理**：提供数据清洗和质量提升功能

---

## 二、技术架构

### 2.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue 3 | 3.3.8 | 前端框架 |
| Vite | 5.0.0 | 构建工具 |
| TypeScript | - | 类型支持 |
| Three.js | 0.162.0 | 3D可视化 |
| Ant Design Vue | 4.0.7 | UI组件库 |
| ECharts | 5.4.3 | 数据可视化 |
| Pinia | 3.0.3 | 状态管理 |
| Vue Router | 4.2.5 | 路由管理 |
| Axios | 1.10.0 | HTTP请求 |
| Less | 4.2.0 | CSS预处理器 |
| Day.js | 1.11.10 | 日期处理 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | - | 后端语言 |
| Flask | 2.3.3 | Web框架 |
| Flask-CORS | 4.0.0 | 跨域支持 |
| TDengine | - | 时序数据库 |

### 2.3 数据库

- **TDengine**：时序数据库，存储实时和历史数据
- **SQL Server**：关系型数据库（部分配置数据）
- **Access**：部分历史数据存储

---

## 三、项目结构

```
污水处理厂源码/
├── src/                          # 前端源代码
│   ├── api/                      # API接口封装
│   │   ├── http.ts              # HTTP请求配置
│   │   ├── offline.ts           # 离线模拟接口
│   │   ├── dataClean.ts         # 数据清洗接口
│   │   ├── historyData.ts       # 历史数据接口
│   │   ├── systemParams.ts      # 系统参数接口
│   │   └── ...
│   ├── components/               # 公共组件
│   │   ├── common/              # 通用组件
│   │   │   ├── DataCleanDialog.vue          # 数据清洗对话框
│   │   │   ├── OfflineOptimizeDialog.vue     # 离线优化对话框
│   │   │   ├── OnlineOptimizationDialog.vue  # 在线优化对话框
│   │   │   ├── SystemParamsDialog.vue        # 系统参数对话框
│   │   │   ├── TrendDialog.vue               # 趋势分析对话框
│   │   │   └── ...
│   │   └── ...
│   ├── view/                     # 页面视图
│   │   ├── shouye/              # 首页
│   │   │   ├── index.vue        # 主页面
│   │   │   ├── components/      # 首页组件
│   │   │   │   ├── BaselineCard.vue    # 基准模式卡片
│   │   │   │   ├── OfflineCard.vue     # 离线模式卡片
│   │   │   │   ├── OnlineCard.vue      # 在线模式卡片
│   │   │   │   └── departments/        # 各工艺部门组件
│   │   │   │       ├── DeptAAO11.vue   # 1#AAO池
│   │   │   │       ├── DeptMBR11.vue   # 1#MBR池
│   │   │   │       └── ...
│   │   │   └── craftAssist.vue  # 工艺辅助
│   │   ├── history/             # 历史数据页面
│   │   │   └── HistoryDataPage.vue
│   │   └── threejs/             # 3D可视化
│   │       ├── index.vue        # 3D场景主组件
│   │       ├── base/            # 基础配置（场景、相机、灯光）
│   │       ├── addSewageModel/  # 污水厂模型加载
│   │       ├── addPeopleModel/  # 人物模型
│   │       ├── addPlant/        # 植物模型
│   │       ├── waterPlane/      # 水面效果
│   │       ├── inspection/      # 巡检功能
│   │       └── label/           # 标签系统
│   ├── modules/                  # 功能模块
│   │   ├── offline/             # 离线模拟模块
│   │   │   ├── pages/           # 页面
│   │   │   ├── composables/     # 组合式函数
│   │   │   ├── configs/         # 配置文件
│   │   │   └── shared/          # 共享组件
│   │   └── router.js            # 路由配置
│   ├── stores/                   # 状态管理
│   │   ├── useOfflineStore.ts   # 离线模块状态
│   │   ├── useSimulationParamsStore.ts  # 模拟参数状态
│   │   └── useAlarmStore.ts     # 告警状态
│   ├── utils/                    # 工具函数
│   ├── App.vue                   # 根组件
│   └── main.js                   # 入口文件
├── backend/                      # 后端源代码
│   ├── app.py                    # Flask应用入口
│   ├── routes/                   # 路由模块
│   │   ├── inflow.py            # 进水数据
│   │   ├── outflow.py           # 出水数据
│   │   ├── water_quality.py     # 水质数据
│   │   ├── offline.py           # 离线模拟
│   │   ├── offline_result.py    # 离线结果
│   │   ├── data_clean.py        # 数据清洗
│   │   ├── history_data.py      # 历史数据
│   │   ├── system_params.py     # 系统参数
│   │   └── trend.py             # 趋势分析
│   ├── services/                 # 业务逻辑层
│   │   ├── offline_service.py
│   │   ├── data_clean_service.py
│   │   ├── system_params_service.py
│   │   └── ...
│   └── models/                   # 数据模型
│       └── tdengine.py          # TDengine模型
├── dbpkg/                        # 数据库封装
│   ├── TDengineDB.py            # TDengine数据库封装
│   ├── SQLServerDB.py           # SQL Server封装
│   ├── AccessDB.py              # Access数据库封装
│   └── config.ini                # 数据库配置
├── public/                       # 静态资源
│   ├── sewageModel.glb          # 污水厂3D模型
│   ├── plant/                   # 植物模型
│   └── ...
├── package.json                  # 前端依赖配置
├── vite.config.js               # Vite配置
├── tsconfig.json                # TypeScript配置
└── README.md                    # 项目说明
```

---

## 四、核心功能模块

### 4.1 三种运行模式

#### 4.1.1 基准模式（Baseline Mode）
- **功能**：展示当前污水处理厂的基准运行状态
- **特点**：基于实际运行数据，不进行模拟和优化
- **用途**：作为对比基准，评估优化效果

#### 4.1.2 离线模式（Offline Mode）
- **功能**：基于历史数据进行离线模拟和优化
- **子模式**：
  - **动态模拟**（Dynamic）：回放历史工况进行模拟
  - **稳态模拟**（Steady-state）：模拟平衡状态
- **优化方式**：
  - **手动优化**：手动设置参数
  - **自动优化**：基于优化目标和约束条件自动寻优
- **应用场景**：
  - 工艺参数优化
  - 运行策略制定
  - 效果评估

#### 4.1.3 在线模式（Online Mode）
- **功能**：基于实时数据进行在线模拟和优化
- **特点**：
  - 实时数据接入
  - 动态参数调整
  - 在线优化控制
- **应用场景**：
  - 实时运行优化
  - 异常预警
  - 自动控制

### 4.2 工艺部门管理

系统支持13个主要工艺部门的监控和管理：

1. **总进出水**（DeptGlobalInOut）
2. **总配水井**（DeptDistributeWell）
3. **1#AAO池**（DeptAAO11）
4. **2#AAO池**（DeptAAO12）
5. **3#AAO池**（DeptAAO13）
6. **4#AAO池**（DeptAAO14）
7. **1#二次沉淀池**（DeptSecondaryClarifier1）
8. **2#二次沉淀池**（DeptSecondaryClarifier2）
9. **二次提升泵房**（DeptLiftPump）
10. **高效沉淀池**（DeptHighEffluentSed）
11. **深床滤池**（DeptDeepBedFilter）
12. **接触消毒池**（DeptContactDisinfection）
13. **出水井**（DeptEffluentWell）

每个工艺部门支持：
- 实时数据展示
- 历史数据查询
- 参数设置
- 趋势分析

### 4.3 3D可视化系统

#### 4.3.1 核心功能
- **3D模型展示**：加载污水厂GLB格式3D模型
- **场景渲染**：使用Three.js实现高质量渲染
- **环境效果**：
  - HDR环境贴图
  - 水面效果（Water Plane）
  - 植物模型（Plant Models）
  - 人物模型（People Models）

#### 4.3.2 交互功能
- **相机控制**：支持旋转、缩放、平移
- **标签系统**：为关键设备添加信息标签
- **巡检功能**：
  - 自动巡检路径
  - 巡检进度控制
  - 巡检速度调节
  - 巡检数据展示面板

#### 4.3.3 技术实现
- **渲染引擎**：Three.js
- **模型格式**：GLB/GLTF
- **动画系统**：Tween.js
- **标签渲染**：CSS2DRenderer

### 4.4 数据清洗模块

#### 4.4.1 功能概述
提供数据质量提升功能，支持多种清洗算法。

#### 4.4.2 清洗算法
- **PCA-DBSCAN**：基于主成分分析和密度聚类的异常检测
- **MPPCA**：多变量主成分分析
- **XGBoost**：基于梯度提升的异常检测

#### 4.4.3 清洗对象
支持对以下指标进行清洗：
- AAODO（AAO溶解氧）
- COD（化学需氧量）
- MBRDO（MBR溶解氧）
- NH3-N（氨氮）
- SS（悬浮物）
- TN（总氮）
- TP（总磷）

#### 4.4.4 清洗效果评估
- 清洗前后数据对比
- 清洗效果可视化
- 数据质量报告

### 4.5 离线模拟与优化

#### 4.5.1 模拟类型
- **动态模拟**：基于历史数据回放，模拟动态过程
- **稳态模拟**：模拟系统平衡状态

#### 4.5.2 优化功能
- **优化算法**：支持多种优化算法配置
- **优化目标**：
  - 出水水质指标优化
  - 能耗优化
  - 运行成本优化
- **约束条件**：
  - 参数范围限制
  - 工艺约束
  - 安全约束

#### 4.5.3 工作流程
1. **选择模式**：选择动态或稳态模拟
2. **选择优化方式**：手动或自动优化
3. **数据集选择**：选择历史数据集
4. **参数设置**：配置模拟和优化参数
5. **执行任务**：提交任务并监控执行状态
6. **结果展示**：查看优化结果和对比分析

### 4.6 在线优化

#### 4.6.1 实时数据接入
- 实时数据采集
- 数据预处理
- 异常检测

#### 4.6.2 在线优化策略
- 实时参数调整
- 动态优化控制
- 异常预警与处理

### 4.7 历史数据查询

#### 4.7.1 功能特点
- **时间范围选择**：支持自定义时间范围查询
- **多指标展示**：同时展示多个水质和流量指标
- **数据对比**：支持清洗前后数据对比
- **图表展示**：使用ECharts进行数据可视化

#### 4.7.2 查询指标
- 总进水量
- AAO流量
- MBR流量
- COD、NH3-N、SS、TN、TP等水质指标

### 4.8 趋势分析

#### 4.8.1 预测功能
- **预测算法**：支持多种预测算法
- **预测步长**：6步、12步、24步可选
- **预测指标**：支持多指标预测

#### 4.8.2 趋势展示
- 历史趋势
- 预测趋势
- 对比分析

### 4.9 系统参数管理

#### 4.9.1 参数分类
- **预测参数**：
  - 预测算法选择
  - 预测步长
  - 模拟间隔
- **数据参数**：
  - 数据类型
  - 校准周期
- **清洗参数**：
  - 清洗算法
  - 容差设置
  - 清洗对象
- **优化参数**：
  - 优化算法
  - 超参数设置
- **限制参数**：
  - 水质指标限值
  - 参数范围限制

#### 4.9.2 参数设置
- 参数编辑
- 参数验证
- 参数保存
- 参数重置

### 4.10 告警与预警

#### 4.10.1 告警类型
- **水质告警**：水质指标超标
- **设备告警**：设备异常
- **运行告警**：运行参数异常

#### 4.10.2 预警功能
- 基于预测模型的预警
- 异常趋势预警
- 告警历史记录

---

## 五、前端架构详解

### 5.1 路由配置

系统采用Vue Router进行路由管理，主要路由包括：

```javascript
/                    # 首页（主控制台）
/history             # 历史数据查询页面
/offline/:process/:mode  # 离线模拟运行页面
/offline/result/:taskId  # 离线结果展示页面
```

### 5.2 状态管理

使用Pinia进行状态管理，主要Store包括：

- **useOfflineStore**：离线模拟模块状态
  - selection：选择项
  - currentStep：当前步骤
  - task：任务信息
  - result：结果数据

- **useSimulationParamsStore**：模拟参数状态
  - 预测参数
  - 优化参数
  - 清洗参数

- **useAlarmStore**：告警状态
  - 告警列表
  - 告警级别

### 5.3 组件架构

#### 5.3.1 页面组件
- **首页**（`src/view/shouye/index.vue`）：主控制台，包含模式切换、工艺选择等
- **历史数据页面**（`src/view/history/HistoryDataPage.vue`）：历史数据查询和展示
- **3D可视化页面**（`src/view/threejs/index.vue`）：3D场景展示

#### 5.3.2 功能组件
- **模式卡片组件**：
  - BaselineCard.vue：基准模式
  - OfflineCard.vue：离线模式
  - OnlineCard.vue：在线模式

- **对话框组件**：
  - DataCleanDialog.vue：数据清洗
  - OfflineOptimizeDialog.vue：离线优化
  - OnlineOptimizationDialog.vue：在线优化
  - SystemParamsDialog.vue：系统参数
  - TrendDialog.vue：趋势分析

#### 5.3.3 工艺部门组件
每个工艺部门都有独立的组件，位于`src/view/shouye/components/departments/`目录下。

### 5.4 API封装

#### 5.4.1 HTTP配置
- **coreApi**：主API实例（`/api`前缀）
- **altApi**：备用API实例（`/alt`前缀，代理到其他后端）
- **http**：默认HTTP实例

#### 5.4.2 API模块
- `offline.ts`：离线模拟相关接口
- `dataClean.ts`：数据清洗接口
- `historyData.ts`：历史数据接口
- `systemParams.ts`：系统参数接口
- `aaoSimulation.ts`：AAO模拟接口
- `simulate.ts`：通用模拟接口

### 5.5 3D可视化实现

#### 5.5.1 场景初始化
- 创建Three.js场景
- 配置相机（透视相机）
- 设置灯光（环境光、方向光）
- 初始化控制器（OrbitControls）

#### 5.5.2 模型加载
- 使用GLTFLoader加载GLB模型
- 模型位置和缩放调整
- 材质和纹理处理

#### 5.5.3 特效实现
- **水面效果**：使用ShaderMaterial实现动态水面
- **环境贴图**：使用RGBELoader加载HDR环境贴图
- **标签系统**：使用CSS2DRenderer实现2D标签

#### 5.5.4 交互功能
- 鼠标控制相机
- 点击拾取（Raycasting）
- 标签显示/隐藏
- 巡检路径动画

---

## 六、后端架构详解

### 6.1 Flask应用结构

```python
app.py                    # 应用入口
├── routes/               # 路由模块
│   ├── inflow.py        # 进水数据路由
│   ├── outflow.py       # 出水数据路由
│   ├── water_quality.py # 水质数据路由
│   ├── offline.py        # 离线模拟路由
│   ├── data_clean.py    # 数据清洗路由
│   └── ...
├── services/             # 业务逻辑层
│   ├── offline_service.py
│   ├── data_clean_service.py
│   └── ...
└── models/               # 数据模型
    └── tdengine.py      # TDengine模型
```

### 6.2 路由模块

#### 6.2.1 数据路由
- **inflow.py**：进水数据查询
- **outflow.py**：出水数据查询
- **water_quality.py**：水质数据查询
- **history_data.py**：历史数据查询

#### 6.2.2 功能路由
- **offline.py**：离线模拟任务管理
  - `/offline/{process}/{mode}/start`：启动离线任务
  - `/offline/task/{taskId}/status`：查询任务状态
  - `/offline/task/{taskId}/result`：获取任务结果
  - `/offline/task/{taskId}/cancel`：取消任务

- **data_clean.py**：数据清洗
  - `/data/clean`：执行数据清洗
  - `/data/clean/effect`：查询清洗效果

- **system_params.py**：系统参数管理
  - `/system/params`：获取/更新系统参数

- **trend.py**：趋势分析
  - `/trend/predict`：趋势预测

### 6.3 服务层

#### 6.3.1 OfflineService
负责离线模拟任务的业务逻辑：
- 任务创建
- 任务状态管理
- 结果处理

#### 6.3.2 DataCleanService
负责数据清洗业务逻辑：
- 清洗算法调用
- 清洗结果处理
- 效果评估

#### 6.3.3 SystemParamsService
负责系统参数管理：
- 参数读取
- 参数验证
- 参数更新

### 6.4 数据库访问

#### 6.4.1 TDengineDB
时序数据库封装，用于：
- 实时数据查询
- 历史数据查询
- 数据写入

#### 6.4.2 数据库配置
配置文件：`dbpkg/config.ini`
- 数据库连接信息
- 软件模块配置
- 算法配置

---

## 七、数据流程

### 7.1 实时数据流程

```
传感器/设备 → TDengine数据库 → 后端API → 前端展示
```

### 7.2 离线模拟流程

```
历史数据选择 → 参数配置 → 任务提交 → 后端处理 → 结果返回 → 前端展示
```

### 7.3 数据清洗流程

```
原始数据 → 清洗算法 → 清洗后数据 → 效果评估 → 数据存储
```

---

## 八、部署说明

### 8.1 前端部署

#### 8.1.1 开发环境
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

#### 8.1.2 生产环境
```bash
# 构建生产版本
npm run build

# 预览构建结果
npm run preview
```

#### 8.1.3 配置说明
- **开发环境**：`VITE_MODE=development`，base路径为`/`
- **生产环境**：`VITE_MODE=production`，base路径为`/sewage/`

### 8.2 后端部署

#### 8.2.1 环境要求
- Python 3.x
- Flask 2.3.3
- TDengine数据库

#### 8.2.2 启动方式
```bash
# Windows
start_backend.bat
# 或
start_backend.ps1

# Linux/Mac
python backend/app.py
```

#### 8.2.3 配置说明
- 默认端口：8000
- CORS已配置，支持跨域请求
- 数据库配置在`dbpkg/config.ini`

### 8.3 代理配置

Vite开发服务器配置了代理：
- `/api` → `http://192.168.3.51:8000`
- `/alt` → `http://192.168.3.91:8000`

### 8.4 数据库配置

#### 8.4.1 TDengine配置
编辑`dbpkg/config.ini`：
```ini
[DatabaseServer]
HOST = 192.168.3.92
USER = root
PASSWORD = taosdata
NAME = beihu_dt
PORT = 6030
```

---

## 九、开发指南

### 9.1 代码规范

#### 9.1.1 Vue组件
- 使用`<script setup>`语法
- 组件命名采用PascalCase
- Props和Emits需要定义类型

#### 9.1.2 TypeScript
- 优先使用TypeScript
- 定义接口和类型
- 避免使用`any`类型

#### 9.1.3 样式
- 使用Less预处理器
- 遵循BEM命名规范
- 响应式设计

### 9.2 新增功能开发

#### 9.2.1 新增页面
1. 在`src/view/`下创建页面组件
2. 在`src/modules/router.js`中添加路由
3. 如需状态管理，创建对应的Store

#### 9.2.2 新增API
1. 在`src/api/`下创建API文件
2. 使用`http`或`coreApi`实例
3. 定义TypeScript类型

#### 9.2.3 新增后端路由
1. 在`backend/routes/`下创建路由文件
2. 在`backend/routes/__init__.py`中注册路由
3. 如需业务逻辑，在`backend/services/`下创建服务

### 9.3 调试技巧

#### 9.3.1 前端调试
- 使用Vue DevTools
- 浏览器控制台查看网络请求
- 使用`console.log`输出调试信息

#### 9.3.2 后端调试
- Flask默认开启debug模式
- 查看控制台日志
- 使用Python调试器

---

## 十、技术亮点

### 10.1 3D可视化
- 使用Three.js实现高质量的3D渲染
- 支持大型场景的优化加载
- 实现交互式巡检功能

### 10.2 数据可视化
- 使用ECharts实现丰富的图表展示
- 支持多指标对比分析
- 实时数据更新

### 10.3 模块化设计
- 前端采用组件化开发
- 后端采用模块化路由
- 便于维护和扩展

### 10.4 类型安全
- 前端使用TypeScript
- 定义完整的类型系统
- 提高代码质量

### 10.5 状态管理
- 使用Pinia进行状态管理
- 清晰的Store结构
- 便于状态追踪

---

## 十一、未来优化方向

### 11.1 用户体验优化
- [ ] 优化页面加载速度
- [ ] 改进交互反馈
- [ ] 增强移动端适配
- [ ] 优化3D场景性能

### 11.2 功能增强
- [ ] 增加更多预测算法
- [ ] 完善告警系统
- [ ] 增加报表导出功能
- [ ] 支持多用户权限管理

### 11.3 性能优化
- [ ] 前端代码分割
- [ ] 3D模型优化
- [ ] 数据查询优化
- [ ] 缓存策略优化

### 11.4 技术升级
- [ ] 升级依赖版本
- [ ] 引入单元测试
- [ ] 增加E2E测试
- [ ] 完善文档

---

## 十二、常见问题

### 12.1 前端问题

**Q: 页面无法加载？**
A: 检查Vite开发服务器是否启动，确认代理配置是否正确。

**Q: 3D模型无法显示？**
A: 检查模型文件路径，确认GLB文件是否存在，查看浏览器控制台错误信息。

**Q: API请求失败？**
A: 检查后端服务是否启动，确认CORS配置，查看网络请求详情。

### 12.2 后端问题

**Q: 数据库连接失败？**
A: 检查`dbpkg/config.ini`配置，确认数据库服务是否运行，检查网络连接。

**Q: 任务执行失败？**
A: 查看后端日志，检查算法模块是否正确安装，确认数据格式是否正确。

---

## 十三、联系方式

如有问题或建议，请联系开发团队。

---

**文档版本**：v1.0  
**最后更新**：2025年11月  
**维护团队**：开发团队

